// =======================================
// ğŸ’» HTML/JavaScriptã‚³ãƒ¼ãƒ‰ (Vercelç”¨)
// ğŸ’¡ ã‚¨ãƒ©ãƒ¼å¯¾ç­–: fetchã« 'Content-Type': 'application/json' ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
// =======================================
// ... (ä¸­ç•¥: HTML/CSS/loadInitialDateãªã©ã®åŸºæœ¬é–¢æ•°ã¯å¤‰æ›´ãªã—) ...

  <script>
    const btn = document.getElementById("btn");
    const result = document.getElementById("result");
    const loadingStatus = document.getElementById("loading-status");

    // ğŸ’¡ ä¿®æ­£å¿…é ˆ: ã‚¹ãƒ†ãƒƒãƒ—1-2ã§å–å¾—ã—ãŸæœ€æ–°ã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyjcV5EtH_cu-uoxBl6Azz9Q4EMgeR6w1d9Z3-FKVyAUMILBafE41d2GMNRyqkQpjK3/exec"; 

    // ... (ä¸­ç•¥: loadInitialDate, createTimeOptions, updateLoadingStatus, extractNumericCosté–¢æ•°ã¯å¤‰æ›´ãªã—) ...
    
    // ğŸ’¡ ä¿®æ­£: GAS APIã‚’å‘¼ã³å‡ºã™å…±é€šé–¢æ•°
    function runGasApi(action, payload = {}) {
        return fetch(GAS_API_URL, {
            method: 'POST',
            // ğŸ’¡ é‡è¦: ã“ã®ãƒ˜ãƒƒãƒ€ãƒ¼ãŒãªã„ã¨GASã®doPostãŒJSONãƒ‡ãƒ¼ã‚¿ã‚’èªè­˜ã§ãã¾ã›ã‚“ï¼
            headers: {
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify({ action, ...payload }), 
            redirect: 'follow' 
        })
        .then(response => {
            if (!response.ok) {
                // HTTPã‚¨ãƒ©ãƒ¼ã®éš›ã«è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º
                throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
            }
            return response.json(); 
        })
        .then(res => {
            if (res.status === 'Error' || res.status === 'ERROR') {
                 throw new Error(res.error || 'API returned an error status.');
            }
            return res; 
        })
    }

    // ğŸ’¡ ä¿®æ­£: fetchAndDisplayDirectionsé–¢æ•°ã‚’runGasApiã‚’ä½¿ã†ã‚ˆã†ã«å¤‰æ›´
    function fetchAndDisplayDirections(originStr, destinationStr, targetId, dateString, hour) {
        const targetElement = document.getElementById(targetId);
        if (!targetElement) return;

        targetElement.innerHTML = `<span class="loading-text">ãƒ«ãƒ¼ãƒˆè¨ˆç®—ä¸­...</span>`;
        
        runGasApi('getDirections', { 
            origin: originStr, 
            destination: destinationStr, 
            mode: 'transit', 
            dateString, 
            hour 
        })
        .then(response => {
            if (response.status === 'OK') {
                targetElement.innerHTML = `<strong>${response.result}</strong>`;
            } else {
                targetElement.innerHTML = `<span class="loading-text error-text" title="${response.error}">è¨ˆç®—ã‚¨ãƒ©ãƒ¼</span>`;
            }
        })
        .catch(err => {
            targetElement.innerHTML = `<span class="loading-text error-text">é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${err.message.substring(0, 20)}...</span>`;
        });
    }
    
    // ğŸ’¡ ä¿®æ­£: fetchAndDisplayCoordinatesé–¢æ•°ã‚’runGasApiã‚’ä½¿ã†ã‚ˆã†ã«å¤‰æ›´
    function fetchAndDisplayCoordinates(spotName, targetId, nextCoordInfo, departureInfo) {
        const targetElement = document.getElementById(targetId);
        if (!targetElement) return;

        targetElement.innerHTML = `<span class="loading-text">ä½æ‰€æ¤œç´¢ä¸­...</span>`;

        runGasApi('getPlaceCoordinates', { spotName: spotName })
        .then(response => {
            updateLoadingStatus('increment_processed'); 
            
            if (response.status === 'OK' && response.lat && response.lng) {
                // ... (ä¸­ç•¥: åº§æ¨™ã¨ãƒ«ãƒ¼ãƒˆè¨ˆç®—ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—) ...
                targetElement.innerHTML = response.address; 
                
                targetElement.dataset.lat = response.lat;
                targetElement.dataset.lng = response.lng;

                const currentCoordsStr = `${response.lat},${response.lng}`;
                
                // 1. æ¬¡ã®ã‚¹ãƒãƒƒãƒˆã¸ã®ãƒ«ãƒ¼ãƒˆè¨ˆç®— (ã‚¹ãƒãƒƒãƒˆé–“ç§»å‹•) - éåŒæœŸå¾…æ©Ÿ
                if (nextCoordInfo) {
                    const nextCoordElement = document.getElementById(nextCoordInfo.coordId);
                    
                    const checkNextSpotCoords = () => {
                        if (nextCoordElement && nextCoordElement.dataset.lat && nextCoordElement.dataset.lng) {
                            const nextCoordsStr = `${nextCoordElement.dataset.lat},${nextCoordElement.dataset.lng}`;
                            fetchAndDisplayDirections(currentCoordsStr, nextCoordsStr, nextCoordInfo.directionsId, nextCoordInfo.date, nextCoordInfo.time); 
                        } else if (document.getElementById(nextCoordInfo.coordId).innerHTML.includes('ã‚¨ãƒ©ãƒ¼')) {
                            return; 
                        } else {
                            setTimeout(checkNextSpotCoords, 500); 
                        }
                    };
                    checkNextSpotCoords();
                }
                
                // 2. æœ€åˆã®ã‚¹ãƒãƒƒãƒˆã®å‡ºç™ºåœ°ã‹ã‚‰ã®ãƒ«ãƒ¼ãƒˆè¨ˆç®—
                if (departureInfo) {
                    fetchAndDisplayDirections(departureInfo.origin, currentCoordsStr, departureInfo.directionsId, departureInfo.date, departureInfo.time);
                }
                
            } else {
                targetElement.innerHTML = `<span class="loading-text error-text" title="${response.error}">ä½æ‰€ãªã—/ã‚¨ãƒ©ãƒ¼</span>`;
            }
        })
        .catch(err => {
            updateLoadingStatus('increment_processed');
            targetElement.innerHTML = `<span class="loading-text error-text">GASé€šä¿¡ã‚¨ãƒ©ãƒ¼: ${err.message.substring(0, 20)}...</span>`;
        });
    }
    // ... (ä¸­ç•¥: renderPlansé–¢æ•°ã¯å¤‰æ›´ãªã—) ...

    /* ==================================== */
    /* ğŸ–±ï¸ ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (æ—…ç¨‹ç”Ÿæˆ) */
    /* ==================================== */
    btn.addEventListener("click", () => {
      // ... (ä¸­ç•¥: dataã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆã¯å¤‰æ›´ãªã—) ...
      const selectedTransports = Array.from(document.querySelectorAll('input[name="transport"]:checked')).map(el => el.value);
      const selectedPrefs = Array.from(document.querySelectorAll('input[name="prefs"]:checked')).map(el => el.value);

      const data = {
        departure: document.getElementById("departure").value.trim(),
        location: document.getElementById("location").value.trim(),
        nights: document.getElementById("nights").value,
        people: document.getElementById("people").value,
        transport: selectedTransports.join('ã€'),
        prefs: selectedPrefs.join('ã€'), 
        departureDate: document.getElementById("departureDate").value,
        arrivalDate: document.getElementById("arrivalDate").value,
        startTime: document.getElementById("startTime").value,
        endTime: document.getElementById("endTime").value,
        action: 'generatePlan' // GASã®doPostã§å‡¦ç†ã™ã‚‹é–¢æ•°ã‚’æŒ‡å®š
      };

      // ... (ä¸­ç•¥: å…¥åŠ›ãƒã‚§ãƒƒã‚¯ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º) ...
      if (!data.location || !data.departure || !data.departureDate || !data.arrivalDate) {
        alert("æ—…è¡Œå…ˆã€å‡ºç™ºåœ°ã€å‡ºç™ºæ—¥ã€åˆ°ç€æ—¥ã®ã™ã¹ã¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„âœˆï¸");
        return;
      }

      result.innerHTML = '';
      updateLoadingStatus('init');
      loadingStatus.innerHTML = `<div class="loading-wrapper"><div class="spinner"></div> 
                                  AIãŒæœ€é©ãªãƒ—ãƒ©ãƒ³ã‚’æ€è€ƒä¸­ã§ã™... (ç´„10ã€œ30ç§’) 
                                  <span class="status-text">â€»ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</span>
                                </div>`;
      
      btn.disabled = true;

      // ğŸ’¡ ä¿®æ­£: runGasApié–¢æ•°ã§çµ±ä¸€çš„ã«APIã‚’å‘¼ã³å‡ºã™
      runGasApi('generatePlan', data)
      .then(res => {
          btn.disabled = false;
          if (res.ok) {
            renderPlans(res.text); 
          } else {
            loadingStatus.style.display = 'none';
            result.innerHTML = "<p style='color:red;'>ã‚¨ãƒ©ãƒ¼: " + res.error + "</p>";
          }
      })
      .catch(err => {
          btn.disabled = false;
          loadingStatus.style.display = 'none';
          // 'Failed to fetch' ã‚¨ãƒ©ãƒ¼ã¯ã€ã»ã¨ã‚“ã©ã®å ´åˆã€CORSã‹URLã®é–“é•ã„ã§ã™ã€‚
          result.innerHTML = "<p style='color:red;'>é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err.message + "</p>";
          if (err.message.includes("Failed to fetch") || err.message.includes("HTTP Error")) {
             result.innerHTML += "<p style='color:orange; font-size:0.9em;'>**ğŸ’¡ã€é‡è¦ã€‘**é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚**GASã®ãƒ‡ãƒ—ãƒ­ã‚¤URL**ãŒæ­£ã—ã„ã‹ã€ã¾ãŸã¯**ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ï¼ˆå…¨å“¡ï¼‰**ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>";
          }
      });
    });
  </script>