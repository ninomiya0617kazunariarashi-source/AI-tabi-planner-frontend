<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>AI Trip Planner âœˆï¸</title>
  <style>
    :root {
      --color-primary: #58A4B1; 
      --color-secondary: #C7E0E5; 
      --color-light-bg: #EAF2F4; 
      --color-white: #ffffff;
      --color-text: #333;
      --color-shadow: rgba(88, 164, 177, 0.4); 
      --font-scale: 1.1;
    }

    body {
      font-family: 'Hiragino Kaku Gothic ProN', 'Arial', sans-serif;
      font-size: calc(16px * var(--font-scale));
      background-color: var(--color-light-bg);
      color: var(--color-text);
      margin: 0;
      padding: 0; 
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      width: 90%; 
      max-width: 1200px; 
      margin: 30px auto; 
      background-color: var(--color-white);
      padding: calc(40px * var(--font-scale));
      border-radius: 15px; 
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      display: flex; 
      flex-direction: column;
      gap: 30px;
    }

    h1 {
      color: var(--color-primary);
      text-align: center;
      margin-bottom: calc(30px * var(--font-scale));
      font-size: calc(2.2em * var(--font-scale));
      text-shadow: 1px 1px 3px rgba(88, 164, 177, 0.2);
    }
    
    .input-section {
      width: 100%; 
      padding: 25px;
      border-radius: 15px;
      background-color: var(--color-secondary); 
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      order: 1; 
    }
    .input-fields-row {
        display: flex;
        flex-wrap: wrap; 
        gap: 20px;
        align-items: flex-end; 
    }
    .input-field-group {
        flex: 1;
        min-width: 180px; 
    }
    
    .input-field-group.date-time-group {
        flex-basis: 150px; 
        min-width: 100px;
    }
    .input-field-group.transport-group {
          order: 5; 
          flex-basis: calc(50% - 10px);
          min-width: 300px;
    }
    .input-field-group.prefs-group {
          order: 6; 
          flex-basis: calc(50% - 10px);
          min-width: 300px;
          margin-top: 10px; 
    }

    .result-section {
        flex: 1; 
        padding: 0; 
        background-color: var(--color-white);
        order: 2; 
    }

    label {
      display: block;
      margin-top: calc(18px * var(--font-scale));
      margin-bottom: calc(5px * var(--font-scale));
      font-weight: 700;
      color: var(--color-primary);
      border-left: 5px solid var(--color-primary); 
      padding-left: 12px;
      font-size: 1em;
    }
    
    .input-section label {
        margin-top: 5px;
    }
    .input-field-group label {
        margin-top: 10px;
    }


    input[type="text"], input[type="number"], input[type="date"], select {
      width: calc(100% - 20px);
      padding: calc(12px * var(--font-scale));
      margin-bottom: calc(12px * var(--font-scale));
      border: 2px solid #A2D5E0; 
      border-radius: 8px;
      background-color: var(--color-white);
      font-size: 1em;
      transition: border-color 0.2s, box-shadow 0.2s;
      box-sizing: border-box; 
    }
    
    input:focus, select:focus, input[type="date"]:focus, input[type="number"]:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 5px rgba(88, 164, 177, 0.5); 
        outline: none;
    }
    
    .checkbox-group {
      border: 1px dashed var(--color-primary);
      padding: 10px;
      border-radius: 10px;
      background-color: #f0ffff; 
      margin-bottom: calc(15px * var(--font-scale));
      box-sizing: border-box;
      width: 100%; 
    }
    .checkbox-group label {
        display: inline-block;
        margin: 5px 15px 5px 0;
        border-left: none;
        font-weight: normal;
        color: var(--color-text);
        padding-left: 0;
        cursor: pointer;
    }

    button#btn {
      background-color: var(--color-primary);
      color: var(--color-white);
      padding: calc(18px * var(--font-scale)) calc(20px * var(--font-scale));
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: calc(1.2em * var(--font-scale));
      font-weight: bold;
      width: 100%;
      margin-top: calc(25px * var(--font-scale));
      transition: background-color 0.2s, transform 0.1s;
      box-shadow: 0 6px 10px var(--color-shadow);
    }
    button#btn:hover:not(:disabled) {
        background-color: #498994; 
        transform: translateY(-3px);
    }
    button#btn:disabled {
        background-color: #aebfd6; 
        cursor: not-allowed;
        box-shadow: none;
    }

    #result {
      margin-top: 20px;
      min-height: 50px;
    }

    .plan-card {
      background-color: var(--color-white);
      border: 1px solid #A2D5E0; 
      border-radius: 15px;
      padding: calc(25px * var(--font-scale));
      margin-bottom: calc(30px * var(--font-scale));
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      border-left: 8px solid var(--color-primary); 
    }
    .plan-card h3 {
      font-size: calc(1.6em * var(--font-scale));
      margin-bottom: 15px;
      color: var(--color-primary);
      border-bottom: 2px dashed #A2D5E0; 
      padding-bottom: 8px;
    }
    .plan-card h3 span {
        display: block; 
        font-size: 0.8em;
        color: #7f8c8d;
        font-weight: normal;
        margin-left: 0; 
        margin-top: 5px; 
        background-color: #f7f7f7;
        padding: 5px 10px;
        border-radius: 8px;
        width: fit-content; 
    }

    .plan-table {
        width: 100%;
        border-collapse: separate; 
        border-spacing: 0 5px; 
        margin-top: 15px;
        font-size: 0.9em;
        table-layout: fixed; 
    }
    .plan-table th, .plan-table td {
        padding: 10px;
        text-align: left;
        word-wrap: break-word; 
        border: none;
        vertical-align: top;
    }
    .plan-table th {
        background-color: #A2D5E0; 
        color: var(--color-text);
        font-weight: bold;
        border-radius: 8px 8px 0 0;
    }
    
    .plan-table th:nth-child(1) { width: 4%; } 
    .plan-table th:nth-child(2) { width: 10%; } 
    .plan-table th:nth-child(3) { width: 16%; } 
    .plan-table th:nth-child(4) { width: 12%; } 
    .plan-table th:nth-child(5) { width: 18%; } 
    .plan-table th:nth-child(6) { width: 10%; } 
    .plan-table th:nth-child(7) { width: 10%; } 
    .plan-table th:nth-child(8) { width: 20%; } 

    .day-header {
      background-color: #C7E0E5 !important; 
      font-weight: bold;
      border-radius: 10px 0 0 10px !important;
    }
    
    .error-text { 
        color: #e74c3c; 
        font-weight: bold;
    }
    .loading-text {
        font-size: 0.7em;
        color: #7f8c8d;
        white-space: nowrap;
    }
    .loading-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .spinner {
        border: 4px solid rgba(88, 164, 177, 0.1);
        border-top: 4px solid var(--color-primary);
        border-radius: 50%;
        width: 12px;
        height: 12px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    #loading-status {
        margin-top: 20px;
        font-weight: bold;
        color: var(--color-primary);
    }
    .status-text {
        font-weight: normal;
        color: #555;
        margin-left: 10px;
    }
  </style>
</head>
<body onload="loadInitialDate()">
  <div class="container">
      <h1>AI Trip Planner âœˆï¸</h1>
      
      <div class="input-section">
          <h2>æ—…ç¨‹ã®æ¡ä»¶è¨­å®š</h2>
          <div class="input-fields-row">
              <div class="input-field-group">
                  <label for="departure">å‡ºç™ºåœ° ğŸ </label>
                  <input id="departure" type="text" placeholder="ä¾‹ï¼šæ±äº¬é§…" value="æ±äº¬é§…">
              </div>

              <div class="input-field-group">
                  <label for="location">æ—…è¡Œå…ˆ ğŸ“</label>
                  <input id="location" type="text" placeholder="ä¾‹ï¼šéŒå€‰" value="éŒå€‰">
              </div>

              <div class="input-field-group" style="max-width: 100px;">
                  <label for="nights">æ³Šæ•° ğŸ›Œ</label>
                  <input id="nights" type="number" min="1" placeholder="ä¾‹ï¼š2" value="1">
              </div>

              <div class="input-field-group" style="max-width: 100px;">
                  <label for="people">äººæ•° ğŸ‘¤</label>
                  <input id="people" type="number" min="1" placeholder="ä¾‹ï¼š1" value="1">
              </div>

              <div class="input-field-group date-time-group">
                  <label for="departureDate">å‡ºç™ºæ—¥ ğŸ“…</label>
                  <input id="departureDate" type="date" value="">
              </div>
              
              <div class="input-field-group date-time-group">
                  <label for="arrivalDate">åˆ°ç€æ—¥ ğŸ“…</label>
                  <input id="arrivalDate" type="date" value="">
              </div>
              
              <div class="input-field-group date-time-group">
                  <label for="startTime">å‡ºç™ºæ™‚é–“ (æ™‚) âŒš</label>
                  <select id="startTime"></select>
              </div>
              
              <div class="input-field-group date-time-group">
                  <label for="endTime">å¸°ç€æ™‚é–“ (æ™‚) âŒ›</label>
                  <select id="endTime"></select>
              </div>

              <div class="input-field-group transport-group">
                  <label>ä¸»ãªäº¤é€šæ‰‹æ®µ ğŸšƒ</label>
                  <div class="checkbox-group" id="transport-group" style="margin-bottom: 0;">
                      <label><input type="checkbox" name="transport" value="é›»è»Š" checked> é›»è»Š</label>
                      <label><input type="checkbox" name="transport" value="é£›è¡Œæ©Ÿ"> é£›è¡Œæ©Ÿ</label>
                      <label><input type="checkbox" name="transport" value="æ–°å¹¹ç·š"> æ–°å¹¹ç·š</label>
                      <label><input type="checkbox" name="transport" value="è»Š"> è»Š</label>
                      <label><input type="checkbox" name="transport" value="ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼"> ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼</label>
                  </div>
              </div>

              <div class="input-field-group prefs-group">
                  <label>ã“ã ã‚ã‚Šãƒ»å¸Œæœ› âœ¨</label>
                  <div class="checkbox-group" id="prefs-group" style="margin-bottom: 0;">
                      <label><input type="checkbox" name="prefs" value="SNSæ˜ ãˆ" checked> SNSæ˜ ãˆ</label>
                      <label><input type="checkbox" name="prefs" value="æ¸©æ³‰"> æ¸©æ³‰</label>
                      <label><input type="checkbox" name="prefs" value="ä¸€äººæ—…"> ä¸€äººæ—…</label>
                      <label><input type="checkbox" name="prefs" value="æµ·å¤–é¢¨"> æµ·å¤–é¢¨</label>
                      <label><input type="checkbox" name="prefs" value="å®¶æ—æ—…è¡Œ"> å®¶æ—æ—…è¡Œ</label>
                      <label><input type="checkbox" name="prefs" value="ã‚°ãƒ«ãƒ¡"> ã‚°ãƒ«ãƒ¡</label>
                      <label><input type="checkbox" name="prefs" value="è‡ªç„¶ãƒ»çµ¶æ™¯"> è‡ªç„¶ãƒ»çµ¶æ™¯</label>
                  </div>
              </div>
          </div>
          
          <div style="display: flex; gap: 20px; align-items: center;">
              <button id="btn">AIã§ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆ âœï¸</button>
              <p class="note" style="margin: 0; font-size: 0.9em; color: #555;">â€»ãƒ—ãƒ©ãƒ³ç”Ÿæˆã«ã¯ç´„10ã€œ30ç§’ã‹ã‹ã‚Šã¾ã™ãŒã€è©³ç´°æƒ…å ±å–å¾—ã¯ä¸¦åˆ—ã§é–‹å§‹ã•ã‚Œã¾ã™ã€‚</p>
          </div>
          
      </div>
      
      <div class="result-section">
          <div id="loading-status" style="display: none;"></div>
          <div id="result">ã“ã“ã«æ—…è¡Œãƒ—ãƒ©ãƒ³ãŒææ¡ˆã•ã‚Œã¾ã™ã€‚</div>
      </div>
  </div>

  <script>
    const btn = document.getElementById("btn");
    const result = document.getElementById("result");
    const loadingStatus = document.getElementById("loading-status");

    // ğŸ’¡ ä¿®æ­£å®Œäº†: ã“ã“ã«ã‚¹ãƒ†ãƒƒãƒ—1ã§å–å¾—ã—ãŸã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®URLã‚’è²¼ã‚Šä»˜ã‘ã¾ã™
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyesqnazgrNZZQE6Lcnw30OfFfqfp23xteYopp5T5uTxbero4WXnRO5GsUrDYYJcKE/exec"; 

    function createTimeOptions(selectId) {
        const selectElement = document.getElementById(selectId);
        selectElement.innerHTML = '';
        for (let i = 0; i <= 23; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i.toString().padStart(2, '0') + ':00';
            selectElement.appendChild(option);
        }
        if (selectId === 'startTime') {
            selectElement.value = '9'; 
        } else if (selectId === 'endTime') {
            selectElement.value = '18'; 
        }
    }
    
    function loadInitialDate() {
        createTimeOptions('startTime');
        createTimeOptions('endTime');
        
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const todayStr = `${yyyy}-${mm}-${dd}`;
        
        document.getElementById('departureDate').value = todayStr;
        document.getElementById('arrivalDate').value = todayStr;
    }
    
    let totalSpotsToProcess = 0;
    let processedSpotsCount = 0;
    
    function updateLoadingStatus(action = 'init') {
        if (action === 'init') {
            loadingStatus.style.display = 'block';
            loadingStatus.innerHTML = `<div class="loading-wrapper"><div class="spinner"></div> AIãŒæ—…ç¨‹ã‚’ç¢ºå®šä¸­...</div>`;
            totalSpotsToProcess = 0;
            processedSpotsCount = 0;
            return;
        }

        if (action === 'start_sub_fetches') {
            loadingStatus.innerHTML = `<div class="loading-wrapper"><div class="spinner"></div> 
                æ—…ç¨‹è©³ç´°æƒ…å ±ã‚’å–å¾—ä¸­... 
                <span class="status-text">(ä½æ‰€ã€ãƒ«ãƒ¼ãƒˆè¨ˆç®—)</span>
            </div>`;
        }

        if (action === 'increment_total') {
            totalSpotsToProcess++;
            return;
        }
        
        if (action === 'increment_processed') {
            processedSpotsCount++;
        }

        if (totalSpotsToProcess > 0 && processedSpotsCount > 0) {
            const percentage = Math.round((processedSpotsCount / totalSpotsToProcess) * 100);
            loadingStatus.innerHTML = `<div class="loading-wrapper"><div class="spinner"></div> 
                è©³ç´°æƒ…å ±ã‚’å–å¾—ä¸­... ${processedSpotsCount}/${totalSpotsToProcess} ã‚¹ãƒãƒƒãƒˆ (${percentage}%) 
                <span class="status-text">â€»æƒ…å ±ã®è¡¨ç¤ºã¯é †æ¬¡è¡Œã‚ã‚Œã¾ã™ã€‚</span>
            </div>`;
        }

        if (processedSpotsCount >= totalSpotsToProcess && totalSpotsToProcess > 0) {
            loadingStatus.innerHTML = `<div class="loading-wrapper"><span style="color:green;">âœ…</span> å…¨ã¦ã®è©³ç´°æƒ…å ±å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚`;
            setTimeout(() => { loadingStatus.style.display = 'none'; }, 5000); 
        }
    }
    
    function extractNumericCost(costString) {
        if (!costString) return Infinity;
        const numericStr = costString.replace(/[^0-9]/g, '');
        return parseInt(numericStr) || Infinity;
    }

    function runGasApi(action, payload = {}) {
        return fetch(GAS_API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify({ action, ...payload }), 
            redirect: 'follow' 
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
            }
            return response.json(); 
        })
        .then(res => {
            if (res.status === 'Error' || res.status === 'ERROR') {
                 throw new Error(res.error || 'API returned an error status.');
            }
            return res; 
        })
    }

    function fetchAndDisplayDirections(originStr, destinationStr, targetId, dateString, hour) {
        const targetElement = document.getElementById(targetId);
        if (!targetElement) return;

        targetElement.innerHTML = `<span class="loading-text">ãƒ«ãƒ¼ãƒˆè¨ˆç®—ä¸­...</span>`;
        
        runGasApi('getDirections', { 
            origin: originStr, 
            destination: destinationStr, 
            mode: 'transit', 
            dateString, 
            hour 
        })
        .then(response => {
            if (response.status === 'OK') {
                targetElement.innerHTML = `<strong>${response.result}</strong>`;
            } else {
                targetElement.innerHTML = `<span class="loading-text error-text" title="${response.error}">è¨ˆç®—ã‚¨ãƒ©ãƒ¼</span>`;
            }
        })
        .catch(err => {
            targetElement.innerHTML = `<span class="loading-text error-text">é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${err.message.substring(0, 20)}...</span>`;
        });
    }
    
    function fetchAndDisplayCoordinates(spotName, targetId, nextCoordInfo, departureInfo) {
        const targetElement = document.getElementById(targetId);
        if (!targetElement) return;

        targetElement.innerHTML = `<span class="loading-text">ä½æ‰€æ¤œç´¢ä¸­...</span>`;

        runGasApi('getPlaceCoordinates', { spotName: spotName })
        .then(response => {
            updateLoadingStatus('increment_processed'); 
            
            if (response.status === 'OK' && response.lat && response.lng) {
                
                targetElement.innerHTML = response.address; 
                
                targetElement.dataset.lat = response.lat;
                targetElement.dataset.lng = response.lng;

                const currentCoordsStr = `${response.lat},${response.lng}`;
                
                if (nextCoordInfo) {
                    const nextCoordElement = document.getElementById(nextCoordInfo.coordId);
                    
                    const checkNextSpotCoords = () => {
                        if (nextCoordElement && nextCoordElement.dataset.lat && nextCoordElement.dataset.lng) {
                            const nextCoordsStr = `${nextCoordElement.dataset.lat},${nextCoordElement.dataset.lng}`;
                            fetchAndDisplayDirections(currentCoordsStr, nextCoordsStr, nextCoordInfo.directionsId, nextCoordInfo.date, nextCoordInfo.time); 
                        } else if (document.getElementById(nextCoordInfo.coordId).innerHTML.includes('ã‚¨ãƒ©ãƒ¼')) {
                            return; 
                        } else {
                            setTimeout(checkNextSpotCoords, 500); 
                        }
                    };
                    checkNextSpotCoords();
                }
                
                if (departureInfo) {
                    fetchAndDisplayDirections(departureInfo.origin, currentCoordsStr, departureInfo.directionsId, departureInfo.date, departureInfo.time);
                }
                
            } else {
                targetElement.innerHTML = `<span class="loading-text error-text" title="${response.error}">ä½æ‰€ãªã—/ã‚¨ãƒ©ãƒ¼</span>`;
            }
        })
        .catch(err => {
            updateLoadingStatus('increment_processed');
            targetElement.innerHTML = `<span class="loading-text error-text">GASé€šä¿¡ã‚¨ãƒ©ãƒ¼: ${err.message.substring(0, 20)}...</span>`;
        });
    }

    function renderPlans(jsonText) {
      loadingStatus.innerHTML = `<div class="loading-wrapper"><div class="spinner"></div> æ—…ç¨‹ã‚’ç”»é¢ã«æç”»ä¸­...</div>`;
      let data;
      try {
        data = JSON.parse(jsonText);
      } catch (e) {
        loadingStatus.style.display = 'none';
        result.innerHTML = `
          <p style="color:red;">âš ï¸ AIã‹ã‚‰ã®å›ç­”ãŒJSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ç”Ÿã®å›ç­”ã‚’ä»£ã‚ã‚Šã«è¡¨ç¤ºã—ã¾ã™ã€‚</p>
          <pre style="white-space: pre-wrap; border: 1px solid #ccc; padding: 15px; background-color: #f9f9f9;">${jsonText}</pre>
        `;
        return;
      }

      if (!data || !data.plans || data.plans.length === 0) {
        loadingStatus.style.display = 'none';
        result.innerHTML = '<p style="color:red;">âš ï¸ AIã‹ã‚‰ã®å›ç­”ãŒç©ºã‹ã€æ­£ã—ã„JSONæ§‹é€ ã«ãªã£ã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
        return;
      }
      
      data.plans.sort((a, b) => {
          const costA = extractNumericCost(a.totalCost);
          const costB = extractNumericCost(b.totalCost);
          return costA - costB;
      });

      let htmlContent = '<h2>âœˆï¸ ã‚ãªãŸã«ã´ã£ãŸã‚Šæ—…è¡Œãƒ—ãƒ©ãƒ³ âœˆï¸</h2>';
      let fetchTargets = []; 
      
      const departureName = document.getElementById("departure").value.trim() || "æ±äº¬é§…";
      const departureDate = document.getElementById('departureDate').value;
      const startTime = parseInt(document.getElementById('startTime').value);
      
      data.plans.forEach((plan, index) => {
        htmlContent += `<div class="plan-card">
          <h3>
            ${index + 1}. ${plan.planTitle || 'ã‚¿ã‚¤ãƒˆãƒ«æœªå®š'} 
            <span class="total-cost">ãƒˆãƒ¼ã‚¿ãƒ«æ¦‚ç®—é‡‘é¡: ${plan.totalCost || 'é‡‘é¡ä¸æ˜'}</span>
          </h3>
          <table class="plan-table">
            <thead>
              <tr>
                <th>Day</th>
                <th>ãƒ†ãƒ¼ãƒ/æ¦‚è¦</th>
                <th>ç«‹ã¡å¯„ã‚Šã‚¹ãƒãƒƒãƒˆ</th>
                <th>ç§»å‹•æ™‚é–“</th> 
                <th>æ¦‚è¦</th>
                <th>æ»åœ¨æ™‚é–“</th> 
                <th>æ¦‚ç®—é‡‘é¡</th>
                <th>ä½æ‰€</th> 
              </tr>
            </thead>
            <tbody>`;

        if (Array.isArray(plan.days)) {
          plan.days.forEach(dayPlan => {
            if (Array.isArray(dayPlan.stops) && dayPlan.stops.length > 0) {
              dayPlan.stops.forEach((stop, stopIndex) => {
                const coordTargetId = `coord-${index}-${dayPlan.day}-${stopIndex}`;
                const directionsTargetId = `dir-${index}-${dayPlan.day}-${stopIndex}`; 
                
                const isFirstStop = stopIndex === 0;
                const isLastStop = stopIndex === dayPlan.stops.length - 1;
                const nextStopIndex = stopIndex + 1;
                const nextCoordTargetId = isLastStop ? null : `coord-${index}-${dayPlan.day}-${nextStopIndex}`;

                htmlContent += `<tr>`;
                
                if (isFirstStop) {
                  htmlContent += `<td rowspan="${dayPlan.stops.length}" class="day-header">Day ${dayPlan.day}</td>`;
                  htmlContent += `<td rowspan="${dayPlan.stops.length}">${dayPlan.theme || ''}</td>`;
                }

                htmlContent += `
                  <td>${stop.spotName || ''}</td>
                  <td><div id="${directionsTargetId}"></div></td> 
                  <td>${stop.description || ''}</td>
                  <td>${stop.time || ''}</td>
                  <td>${stop.cost || 'ä¸æ˜'}</td>
                  <td><div id="${coordTargetId}"></div></td> 
                </tr>`;
                
                if (stop.spotName) {
                    updateLoadingStatus('increment_total'); 
                    
                    let nextCoordInfo = null;
                    if (!isLastStop) {
                        nextCoordInfo = {
                            coordId: nextCoordTargetId,
                            directionsId: `dir-${index}-${dayPlan.day}-${nextStopIndex}`,
                            date: departureDate, 
                            time: startTime,
                        };
                    }
                    
                    let departureInfo = null;
                    if (isFirstStop && dayPlan.day === 1) {
                         departureInfo = {
                            origin: departureName,
                            directionsId: directionsTargetId, 
                            date: departureDate, 
                            time: startTime,
                        };
                    }
                    
                    fetchTargets.push({ 
                        name: stop.spotName, 
                        coordId: coordTargetId,
                        nextCoordInfo: nextCoordInfo,
                        departureInfo: departureInfo, 
                    });
                }
              });
            } else {
                 htmlContent += `<tr>
                    <td class="day-header">Day ${dayPlan.day}</td>
                    <td>${dayPlan.theme || 'æƒ…å ±ãªã—'}</td>
                    <td colspan="6">ã“ã®æ—¥ã®ã‚¹ãƒãƒƒãƒˆæƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</td>
                </tr>`;
            }
          });
        }

        htmlContent += `</tbody></table></div>`;
      });
      
      result.innerHTML = htmlContent;
      
      updateLoadingStatus('start_sub_fetches');

      fetchTargets.forEach(item => {
          fetchAndDisplayCoordinates(item.name, item.coordId, item.nextCoordInfo, item.departureInfo);
      });
    }

    btn.addEventListener("click", () => {
      const selectedTransports = Array.from(document.querySelectorAll('input[name="transport"]:checked')).map(el => el.value);
      const selectedPrefs = Array.from(document.querySelectorAll('input[name="prefs"]:checked')).map(el => el.value);

      const data = {
        departure: document.getElementById("departure").value.trim(),
        location: document.getElementById("location").value.trim(),
        nights: document.getElementById("nights").value,
        people: document.getElementById("people").value,
        transport: selectedTransports.join('ã€'),
        prefs: selectedPrefs.join('ã€'), 
        departureDate: document.getElementById("departureDate").value,
        arrivalDate: document.getElementById("arrivalDate").value,
        startTime: document.getElementById("startTime").value,
        endTime: document.getElementById("endTime").value,
        action: 'generatePlan' 
      };

      if (!data.location || !data.departure || !data.departureDate || !data.arrivalDate) {
        alert("æ—…è¡Œå…ˆã€å‡ºç™ºåœ°ã€å‡ºç™ºæ—¥ã€åˆ°ç€æ—¥ã®ã™ã¹ã¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„âœˆï¸");
        return;
      }

      result.innerHTML = '';
      updateLoadingStatus('init');
      loadingStatus.innerHTML = `<div class="loading-wrapper"><div class="spinner"></div> 
                                  AIãŒæœ€é©ãªãƒ—ãƒ©ãƒ³ã‚’æ€è€ƒä¸­ã§ã™... (ç´„10ã€œ30ç§’) 
                                  <span class="status-text">â€»ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</span>
                                </div>`;
      
      btn.disabled = true;

      runGasApi('generatePlan', data)
      .then(res => {
          btn.disabled = false;
          if (res.ok) {
            renderPlans(res.text); 
          } else {
            loadingStatus.style.display = 'none';
            result.innerHTML = "<p style='color:red;'>ã‚¨ãƒ©ãƒ¼: " + res.error + "</p>";
          }
      })
      .catch(err => {
          btn.disabled = false;
          loadingStatus.style.display = 'none';
          result.innerHTML = "<p style='color:red;'>é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err.message + "</p>";
          if (err.message.includes("Failed to fetch") || err.message.includes("HTTP Error")) {
             result.innerHTML += "<p style='color:orange; font-size:0.9em;'>**ğŸ’¡ã€é‡è¦ã€‘**é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚**GASã®ãƒ‡ãƒ—ãƒ­ã‚¤URL**ãŒæ­£ã—ã„ã‹ã€ã¾ãŸã¯**ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ï¼ˆå…¨å“¡ï¼‰**ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>";
          }
      });
    });
  </script>
</body>
</html>